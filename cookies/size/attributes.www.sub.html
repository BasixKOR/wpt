<!doctype html>
<html>

<head>
  <meta charset=utf-8>
  <title>Test cookie attribute size restrictions</title>
  <meta name=help href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-rfc6265bis#section-5.4">
  <meta name="timeout" content="long">
  <script src="/resources/testharness.js"></script>
  <script src="/resources/testharnessreport.js"></script>
  <script src="/cookies/resources/cookie-test.js"></script>
</head>

<body>
  <div id=log></div>
  <script>
    const host = "{{host}}";
    const attrSizeTests = [
      {
        cookie: `test=1; path=/cookies/size; path=/cookies/siz${"e".repeat(1024)}`,
        expected: "test=1",
        name: "Too long path attribute (>1024 bytes) is ignored; previous valid path wins.",
        defaultPath: false,
      },
      {
        cookie: `test=2; path=/cookies/siz${"e".repeat(1024)}; path=/cookies/size`,
        expected: "test=2",
        name: "Too long path attribute (>1024 bytes) is ignored; next valid path wins.",
        defaultPath: false,
      },
      {
        cookie: `test=3; path=/cookies/size; path=/${"a".repeat(1023)};`,
        expected: "",
        name: "Max size path attribute (==1024 bytes) is not ignored; as expected",
        defaultPath: false,
      },
      {
        cookie: `test=4; path=/cookies/size; path=/${"a".repeat(1024)};`,
        expected: "test=4",
        name: "Too long path attribute (==1025 bytes) is ignored; as expected",
        defaultPath: false,
      },
      {
        // This page opens on the www subdomain, so we set domain to {{host}}
        // to see if anything works as expected.
        cookie: `test=5; domain=${host}; domain=${"a".repeat(1024)}.com`,
        expected: "test=5",
        name: "Too long domain attribute (>1024 bytes) is ignored; previous valid domain wins.",
        location: `http://${host}/cookies/size/attributes.www.sub.html`,
      },
      {
        cookie: `test=6; domain=${"a".repeat(1024)}.com; domain=${host}`,
        expected: "test=6",
        name: "Too long domain attribute (>1024 bytes) is ignored; next valid domain wins.",
        location: `http://${host}/cookies/size/attributes.www.sub.html`,
      },
      {
        cookie: `test=7; domain=${"a".repeat(1020)}.com;`,
        expected: "",
        name: "Max size domain attribute (==1024 bytes) is not ignored; as expected"
      },
      {
        cookie: `test=8; domain=${"a".repeat(1021)}.com;`,
        expected: "test=8",
        name: "Too long domain attribute (==1025 bytes) is ignored; as expected"
      },
      {
        cookie: cookieStringWithNameAndValueLengths(2048, 2048) +
          `; domain=${"a".repeat(1020)}.com; domain=${host}`,
        expected: cookieStringWithNameAndValueLengths(2048, 2048),
        name: "Set max-size cookie that also has max-size attribute",
      },
      {
        cookie: cookieStringWithNameAndValueLengths(2048, 2048) +
          `; domain=${"a".repeat(1020)}.com` +
          `; domain=${"a".repeat(1020)}.com` +
          `; domain=${"a".repeat(1020)}.com` +
          `; domain=${"a".repeat(1020)}.com; domain=${host}`,
        expected: cookieStringWithNameAndValueLengths(2048, 2048),
        name: "Set max-size cookie with multiple max-size attributes (>8k bytes total)",
      },
    ];

    for (const test of attrSizeTests) {
      httpCookieTest(test.cookie, test.expected, test.name, test.defaultPath);
    }
  </script>
</body>

</html>
